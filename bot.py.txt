import telebot
from telebot import types
import os

TOKEN = os.getenv("TELEGRAM_TOKEN")
ADMIN_CHAT_ID = int(os.getenv("ADMIN_CHAT_ID"))

bot = telebot.TeleBot(TOKEN)
user_data = {}

@bot.message_handler(commands=['start'])
def start(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add(types.KeyboardButton("–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ñ–æ—Ç–æ"))
    markup.add(types.KeyboardButton("–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤–∏–¥–µ–æ"))
    markup.add(types.KeyboardButton("–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ä–∏–ª—Å"))
    markup.add(types.KeyboardButton("–û—Å—Ç–∞–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"))
    bot.send_message(message.chat.id, "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=markup)

@bot.message_handler(func=lambda msg: msg.text in [
    "–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ñ–æ—Ç–æ",
    "–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤–∏–¥–µ–æ",
    "–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ä–∏–ª—Å"
])
def start_request(message):
    user_data[message.chat.id] = {"type": msg_type = message.text.replace("–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ ", "")}
    msg = bot.send_message(message.chat.id, "üìÖ –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É —Å—ä—ë–º–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 2025-12-01):")
    bot.register_next_step_handler(msg, ask_place)

def ask_place(message):
    user_data[message.chat.id]["date"] = message.text
    msg = bot.send_message(message.chat.id, "üìç –£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å—ä—ë–º–∫–∏:")
    bot.register_next_step_handler(msg, ask_time)

def ask_time(message):
    user_data[message.chat.id]["place"] = message.text
    msg = bot.send_message(message.chat.id, "‚è∞ –£–∫–∞–∂–∏—Ç–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 10:00-12:00):")
    bot.register_next_step_handler(msg, ask_comment)

def ask_comment(message):
    user_data[message.chat.id]["time"] = message.text
    msg = bot.send_message(message.chat.id, "üìù –ü–æ–∂–µ–ª–∞–Ω–∏—è –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º):")
    bot.register_next_step_handler(msg, finish_request)

def finish_request(message):
    user_data[message.chat.id]["comment"] = message.text or "‚Äî"
    d = user_data[message.chat.id]
    username = message.from_user.username or f"{message.from_user.first_name}"
    text = (
        "üìå *–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ —Å—ä—ë–º–∫—É*\n\n"
        f"üé¨ –¢–∏–ø: {d['type']}\n"
        f"üìÖ –î–∞—Ç–∞: {d['date']}\n"
        f"üìç –ú–µ—Å—Ç–æ: {d['place']}\n"
        f"‚è∞ –ü—Ä–æ–º–µ–∂—É—Ç–æ–∫: {d['time']}\n"
        f"üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: {d['comment']}\n\n"
        f"üë§ –ö–ª–∏–µ–Ω—Ç: @{message.from_user.username if message.from_user.username else username}"
    )
    bot.send_message(ADMIN_CHAT_ID, text, parse_mode="Markdown")
    bot.send_message(message.chat.id, "–°–ø–∞—Å–∏–±–æ, –≤–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 3 –¥–Ω–µ–π.", reply_markup=types.ReplyKeyboardRemove())

@bot.message_handler(func=lambda msg: msg.text == "–û—Å—Ç–∞–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π")
def comment_start(message):
    msg = bot.send_message(message.chat.id, "–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ:")
    bot.register_next_step_handler(msg, send_comment)

def send_comment(message):
    username = message.from_user.username or message.from_user.first_name
    bot.send_message(ADMIN_CHAT_ID, f"üì® –ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ:\n{message.text}\n–û—Ç: @{message.from_user.username if message.from_user.username else username}")
    bot.send_message(message.chat.id, "–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!", reply_markup=types.ReplyKeyboardRemove())

if __name__ == "__main__":
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    bot.infinity_polling()
